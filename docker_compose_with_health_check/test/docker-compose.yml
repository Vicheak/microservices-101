version: "3.8"

services: 
   rabbit:                  
      image: rabbitmq:3.12-management
      container_name: rabbitmq
      hostname: rabbitmq
      healthcheck:
        test: rabbitmq-diagnostics check_port_connectivity
        interval: 10s
        timeout: 5s
        retries: 10
        start_period: 10s
      ports:
        - "5672:5672"
        - "15672:15672"
      networks:
         - vicheaknetwork

   configserver:
      image: vicheakbank/configserver:v2
      container_name: configserver
      mem_limit: 700m
      healthcheck:
         test: "curl --fail --silent localhost:8071/actuator/health/readiness | grep UP || exit 1"
         interval: 10s
         timeout: 5s
         retries: 10
         start_period: 10s
      ports:
        - "8071:8071"
      networks:
        - vicheaknetwork
      depends_on:
         rabbit: 
            condition: service_healthy
      environment:
         SPRING_RABBITMQ_HOST: rabbit

   account_service:
      image: vicheakbank/account:v2
      container_name: account_service
      mem_limit: 700m
      ports:
         - "8080:8080"
      networks:
         - vicheaknetwork
      depends_on:
         configserver:
            condition: service_healthy
      environment:
         SPRING_RABBITMQ_HOST: rabbit
         SPRING_PROFILES_ACTIVE: default
         SPRING_CONFIG_IMPORT: configserver:http://configserver:8071/

   loan_service:
      image: vicheakbank/loan:v2
      container_name: loan_service
      mem_limit: 700m
      ports:
         - "8090:8090"
      networks:
         - vicheaknetwork
      depends_on:
         configserver:
            condition: service_healthy
      environment:
         SPRING_RABBITMQ_HOST: rabbit
         SPRING_PROFILES_ACTIVE: default
         SPRING_CONFIG_IMPORT: configserver:http://configserver:8071/
         MONGODB_HOST_NAME: mongodb

   card_service:
      image: vicheakbank/card:v2
      container_name: card_service
      mem_limit: 700m
      ports:
         - "8070:8070"
      networks:
         - vicheaknetwork
      depends_on:
         configserver:
            condition: service_healthy
      environment:
         SPRING_RABBITMQ_HOST: rabbit
         SPRING_PROFILES_ACTIVE: default
         SPRING_CONFIG_IMPORT: configserver:http://configserver:8071/
         MONGODB_HOST_NAME: mongodb

   mongodb:
      image: mvertes/alpine-mongo:latest
      container_name: mongodb
      ports: 
         - "7777:27017"
      networks:
         - vicheaknetwork

networks:
    vicheaknetwork: